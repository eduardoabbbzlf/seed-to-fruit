<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mind-to-Delivery (Login + Dashboard Base)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111823; --panel2:#0f1620; --text:#e8eef7;
      --muted:#9fb0c3; --line:#223044; --ok:#31d07f; --warn:#f5c84b; --bad:#ff5a6a;
      --chip:#1a2533; --accent:#6aa9ff; --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#070a0f 0%, #0b0f14 30%, #0b0f14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,20,.85); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .title{display:flex; gap:12px; align-items:center}
    .badge{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);color:var(--muted);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .btn.primary{background:var(--accent); color:#06111f; border-color:transparent}
    .btn.danger{background:transparent; color:var(--bad); border-color:#3a1b22}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    footer{color:var(--muted); padding:22px 0}

    /* Modal (Wizard "Nova ideia?") - mantido no CSS (não usado nessa base) */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:999;
      padding:16px;
    }
    .modal{
      width:min(920px, 100%); max-height:86vh; overflow:auto;
      background:var(--panel); border:1px solid var(--line); border-radius:18px;
      padding:14px;
    }
    .q{
      border:1px solid var(--line); background:#0c121c;
      border-radius:12px; padding:12px; margin:10px 0;
    }
    .q label{display:block; font-weight:800; margin-bottom:8px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--line); background:#08101a; color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .small{font-size:12px}

    .formEmail{margin-bottom: 4%;}
    #authPassword{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#08101a; color:var(--text); outline:none;}
    #authPassword2 {width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#08101a; color:var(--text); outline:none;}
    #btnForgotPass:hover {color: #89CFFF; cursor: pointer;}
    #btnToggleAuthMode:hover {color: #89CFFF; cursor: pointer; text-decoration: underline;}

    .linha-ou {
      display: flex;
      align-items: center;
      text-align: center;
      color: #888;
    }
    .linha-ou::before,
    .linha-ou::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #223044;
    }
    .linha-ou:not(:empty)::before { margin-right: 10px; }
    .linha-ou:not(:empty)::after { margin-left: 10px; }

    #btnAuthSubmit {width: 100%;}
    #forgotEmail, #forgotEmail2 {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--line); background:#08101a; color:var(--text); outline:none;
    }

    .gsi-material-button {
      display: flex;
      justify-content: center;
      background-color: WHITE;
      background-image: none;
      border: 1px solid #747775;
      -webkit-border-radius: 20px;
      border-radius: 20px;
      -webkit-box-sizing: border-box;
      box-sizing: border-box;
      color: #1f1f1f;
      cursor: pointer;
      font-family: 'Roboto', arial, sans-serif;
      font-size: 14px;
      height: 40px;
      letter-spacing: 0.25px;
      outline: none;
      overflow: hidden;
      padding: 0 12px;
      position: relative;
      text-align: center;
      -webkit-transition: background-color .218s, border-color .218s, box-shadow .218s;
      transition: background-color .218s, border-color .218s, box-shadow .218s;
      vertical-align: middle;
      white-space: nowrap;
      width: auto;
      min-width: min-content;
    }
    .gsi-material-button .gsi-material-button-icon {
      height: 20px;
      margin-right: 10px;
      min-width: 20px;
      width: 20px;
    }
    .gsi-material-button .gsi-material-button-content-wrapper {
      -webkit-align-items: center;
      align-items: center;
      display: flex;
      -webkit-flex-direction: row;
      flex-direction: row;
      -webkit-flex-wrap: nowrap;
      flex-wrap: nowrap;
      height: 100%;
      justify-content: center;
      position: relative;
      width: 100%;
    }
    .gsi-material-button .gsi-material-button-contents {
      -webkit-flex-grow: 0;
      flex-grow: 0;
      font-family: 'Roboto', arial, sans-serif;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: top;
    }
    .gsi-material-button .gsi-material-button-state {
      -webkit-transition: opacity .218s;
      transition: opacity .218s;
      bottom: 0;
      left: 0;
      opacity: 0;
      position: absolute;
      right: 0;
      top: 0;
    }
    .gsi-material-button:disabled {
      cursor: default;
      background-color: #ffffff61;
      border-color: #1f1f1f1f;
    }
    .gsi-material-button:disabled .gsi-material-button-contents { opacity: 38%; }
    .gsi-material-button:disabled .gsi-material-button-icon { opacity: 38%; }
    .gsi-material-button:not(:disabled):active .gsi-material-button-state,
    .gsi-material-button:not(:disabled):focus .gsi-material-button-state {
      background-color: #303030;
      opacity: 12%;
    }
    .gsi-material-button:not(:disabled):hover {
      -webkit-box-shadow: 0 1px 2px 0 rgba(60, 64, 67, .30), 0 1px 3px 1px rgba(60, 64, 67, .15);
      box-shadow: 0 1px 2px 0 rgba(60, 64, 67, .30), 0 1px 3px 1px rgba(60, 64, 67, .15);
    }
    .gsi-material-button:not(:disabled):hover .gsi-material-button-state {
      background-color: #303030;
      opacity: 8%;
    }
  </style>
</head>

<body>

<!-- =========================
     LOGIN SCREEN (mantido)
========================= -->
<div id="authScreen" style="display:none; max-width:520px; margin:40px auto; padding:16px;">
  <div style="border:1px solid #223044; border-radius:14px; background:#111823; padding:16px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <h2 style="margin:0 0 6px 0; width: 100%">Entrar</h2>
        <p>Não tem uma conta? <a id="btnToggleAuthMode">Se increva aqui!</a></p>
      </div>
      <span id="authModeBadge" class="badge" style="white-space:nowrap;">Modo: Login</span>
    </div>

    <div class="sep"></div>

    <!-- Mensagem -->
    <p id="authMsg" style="margin:0 0 12px 0; color:#9fb0c3; font-size:13px;"></p>

    <!-- Campos comuns -->
    <div class="formEmail">
      <input id="authEmail" type="text" placeholder="Email" autocomplete="email" />
        <div id="authEmailErr" class="small" style="display:none; margin-top:8px; color: var(--bad);"></div>
    </div>

    <div class="formSenha">
      <input id="authPassword" type="password" placeholder="Senha" autocomplete="current-password" />

      <!-- Link visível (já existia) -->
      <div class="muted small" style="margin-top:8px; margin-bottom: 4%; text-decoration: underline;">
        <a id="btnForgotPass">Esqueci a senha</a>
      </div>

      <!-- botão antigo escondido (mantido para não quebrar nada, mas sem ID duplicado) -->
      <button type="button" class="link" style="display:none;">
        Esqueci a senha
      </button>

      <div id="forgotContainer" style="display:none; margin-top:12px;">
        <div class="sep"></div>

        <div class="q" style="margin:0 0 10px 0;">
          <label for="forgotEmail">E-mail para recuperação</label>
          <input id="forgotEmail" type="email" placeholder="seuemail@dominio.com" autocomplete="email" />
        </div>

        <div class="q" style="margin:0 0 10px 0;">
          <label for="forgotEmail2">Confirmar e-mail</label>
          <input id="forgotEmail2" type="email" placeholder="repita seu e-mail" autocomplete="email" />
        </div>

        <div class="row" style="justify-content:space-between; gap:10px; margin-top:10px;">
          <button class="btn primary" id="btnSendReset" type="button">Enviar link</button>
          <button class="btn" id="btnCloseForgot" type="button">Fechar</button>
        </div>

        <p class="muted small" style="margin-top:10px;">
          Você receberá um link por e-mail para redefinir sua senha.
        </p>
      </div>
    </div>

    <!-- Campos do cadastro (escondidos no modo login) -->
    <div id="signupFields" style="display:none;">
      <div class="q" style="margin:0 0 10px 0;">
        <label for="authPassword2">Repetir senha</label>
        <input id="authPassword2" type="password" placeholder="••••••••" autocomplete="new-password" />
      </div>

      <div class="q" style="margin:0 0 10px 0;">
        <label for="authName">Nome</label>
        <input id="authName" type="text" placeholder="Seu nome" autocomplete="name" />
      </div>

      <div class="q" style="margin:0 0 10px 0;">
        <label>Data de nascimento</label>

        <div class="row" style="gap:10px;">
          <select id="birthDay" class="input" style="flex:1;">
            <option value="">Dia</option>
          </select>

          <select id="birthMonth" class="input" style="flex:1;">
            <option value="">Mês</option>
            <option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option>
            <option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option>
            <option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option>
            <option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option>
          </select>

          <select id="birthYear" class="input" style="flex:1;">
            <option value="">Ano</option>
          </select>
        </div>

        <!-- valor final (compatível com seu JS atual) -->
        <input id="authBirth" type="hidden" />
      </div>

      <div class="q" style="margin:0 0 10px 0;">
        <label for="authCity">Onde você mora</label>
        <input id="authCity" type="text" placeholder="Cidade/Estado" autocomplete="address-level2" />
      </div>
    </div>

    <div>
      <div class="row" style="margin-bottom: 3%;">
        <button class="btn primary" id="btnAuthSubmit">Entrar</button>
      </div>
    </div>

    <div class="linha-ou">
      <span>Ou</span>
    </div>

    <div>
      <button id="btnLoginGoogle" class="gsi-material-button" style="width:100%; margin-top: 5%;">
        <div class="gsi-material-button-state"></div>
        <div class="gsi-material-button-content-wrapper">
          <div class="gsi-material-button-icon">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: block;">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
              <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>
          </div>
          <span class="gsi-material-button-contents">Entrar com conta Google</span>
          <span style="display: none;">Entrar com conta Google</span>
        </div>
      </button>

      <!-- (corrigido: sem ID duplicado) -->
      <p id="authMsg2" style="margin-top:12px; color:#9fb0c3; font-size:12px;"></p>
    </div>
  </div>
</div>


<!-- =========================
     APP ROOT (Dashboard Base)
     ✅ removida a estrutura antiga do dashboard
     ✅ mantido só: botão Perfil + botão Sair no topo
========================= -->
<div id="appRoot" style="display:none;">
  <header>
    <div class="wrap">
      <div class="top">
        <div class="title">
          <div style="font-weight:900; font-size:15px;">Mind-to-Delivery</div>
          <span class="badge">Dashboard Base</span>
        </div>

        <div class="row">
          <button id="btnGoProfile" class="btn">Perfil</button>
          <button id="btnLogoutTop" class="btn danger">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- View: Dashboard -->
    <section id="viewDashboard" class="card">
      <h2>Dashboard</h2>
      <p class="muted">Base pronta. A partir daqui vamos adicionar os módulos por fases (sem bagunça).</p>
      <div class="sep"></div>
      <div class="muted small" id="dashUserLine">Carregando usuário…</div>
    </section>

    <!-- Modal: Nova ideia -->
    <div id="ideaModalBack" class="modalBack">
      <div class="modal">
        <div class="row" style="justify-content:space-between;">
          <h2 style="margin:0;">Nova ideia (Semente)</h2>
          <button id="btnCloseIdeaModal" class="btn">Fechar</button>
        </div>
        <div class="sep"></div>

        <div class="q">
          <label>Título curto da ideia</label>
          <input id="ideaTitle" type="text" placeholder="Ex: App para organizar estudos com rotina" />
          <div class="muted small">Dica: curto e direto (5–9 palavras).</div>
        </div>

        <div class="q">
          <label>Explique a ideia do jeito mais simples</label>
          <textarea id="ideaRaw" placeholder="Escreva como se estivesse contando pra um amigo."></textarea>
        </div>

        <div class="q">
          <label>Quem é o usuário?</label>
          <input id="ideaUser" type="text" placeholder="Ex: estudantes que se perdem na rotina" />
        </div>

        <div class="q">
          <label>Qual dor principal?</label>
          <input id="ideaPain" type="text" placeholder="Ex: não conseguem manter consistência e se frustram" />
        </div>

        <div class="row" style="justify-content:flex-end; gap:10px;">
          <button id="btnCreateIdea" class="btn primary">Criar projeto</button>
        </div>

        <p id="ideaModalMsg" class="muted small" style="margin-top:10px;"></p>
      </div>
    </div>


    <!-- =========================
     SeedToFruit: Empty State + Modal "Primeira Ideia"
    ========================= -->
    <section id="seedEmptyState" class="card" style="display:none; position:relative; overflow:hidden;">
      <h2>SeedToFruit</h2>
      <p class="muted">Você ainda não tem uma ideia ativa. Comece plantando sua primeira semente.</p>

      <!-- “Gráficos borrados” (placeholder visual) -->
      <div style="margin-top:12px; display:grid; gap:10px;">
        <div style="height:90px; border-radius:14px; border:1px solid #223044; background:#0f1620; filter:blur(2px); opacity:.7;"></div>
        <div style="height:90px; border-radius:14px; border:1px solid #223044; background:#0f1620; filter:blur(2px); opacity:.7;"></div>
      </div>

      <!-- Botão na frente -->
      <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
        <button id="btnAddFirstIdea" class="btn primary" style="font-size:14px; padding:12px 16px;">
          Adicione sua primeira ideia
        </button>
      </div>
    </section>

    <div id="ideaModalBack" class="modalBack">
      <div class="modal">
        <div class="row" style="justify-content:space-between;">
          <h2 style="margin:0;">Nova ideia (Semente)</h2>
          <button id="btnCloseIdeaModal" class="btn">Fechar</button>
        </div>
        <div class="sep"></div>

        <div class="q">
          <label>Título curto da ideia</label>
          <input id="ideaTitle" type="text" placeholder="Ex: App para organizar estudos com rotina" />
          <div class="muted small">Dica: curto e direto (5–9 palavras).</div>
        </div>

        <div class="q">
          <label>Explique a ideia do jeito mais simples</label>
          <textarea id="ideaRaw" placeholder="Escreva como se estivesse contando pra um amigo."></textarea>
        </div>

        <div class="q">
          <label>Quem é o usuário?</label>
          <input id="ideaUser" type="text" placeholder="Ex: estudantes que se perdem na rotina" />
        </div>

        <div class="q">
          <label>Qual dor principal?</label>
          <input id="ideaPain" type="text" placeholder="Ex: não conseguem manter consistência e se frustram" />
        </div>

        <div class="row" style="justify-content:flex-end; gap:10px;">
          <button id="btnCreateIdea" class="btn primary">Criar projeto</button>
        </div>

        <p id="ideaModalMsg" class="muted small" style="margin-top:10px;"></p>
      </div>
    </div>


    <!-- View: Perfil -->
    <section id="viewProfile" class="card" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;">Perfil</h2>
        <button id="btnBackDashboard" class="btn">Voltar</button>
      </div>
      <div class="sep"></div>

      <div class="q" style="margin:0;">
        <label>Dados da conta</label>
        <div class="muted small" id="profileEmail">—</div>
        <div class="muted small" id="profileProvider">—</div>
      </div>

      <div class="sep"></div>

      <div class="q" style="margin:0;">
        <label>Metadados (Supabase)</label>
        <pre id="profileMeta" style="margin:0; white-space:pre-wrap; color:var(--text); font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></pre>
      </div>
    </section>
  </main>

  <footer class="wrap muted small">
    Base limpa • Login (Email/Senha + Google) via Supabase • Vercel
  </footer>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  let __pauseProjectFetchUntil = 0;

  function pauseProjectFetch(ms, why) {
    __pauseProjectFetchUntil = Date.now() + ms;
    console.log(`[SeedToFruit] pause fetch ${ms}ms (${why})`);
  }

  function isProjectFetchPaused() {
    return Date.now() < __pauseProjectFetchUntil;
  }


  window.__scriptLoads = (window.__scriptLoads || 0) + 1;
  console.log("[APP] script loads:", window.__scriptLoads);


  // ✅ se algo falhar, pelo menos mostra login em vez de branco
  const authScreen = document.getElementById("authScreen");
  const appRoot = document.getElementById("appRoot");
  const authMsg = document.getElementById("authMsg");
  const btnLoginGoogle = document.getElementById("btnLoginGoogle");

  function showLogin(message = "") {
    if (appRoot) appRoot.style.display = "none";
    if (authScreen) authScreen.style.display = "block";
    if (authMsg) authMsg.textContent = message;
  }
  function showApp() {
    if (authScreen) authScreen.style.display = "none";
    if (appRoot) appRoot.style.display = "block";
  }

  window.showLogin = showLogin;
  window.showApp = showApp;


  const SUPABASE_URL = "https://zbttjwqanlphsnyecobh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpidHRqd3FhbmxwaHNueWVjb2JoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNjI1NzMsImV4cCI6MjA4NDkzODU3M30.r9ZC1GmID0e7Zrwlck0iXMi5Qa9tsZLaA75S1NF9mvo";

  // =========================
  // Supabase singleton (1x)
  // =========================
  if (!window.__supabase) {
    window.__supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storageKey: "seedtofruit-auth" // evita conflito com outros apps/testes
        }
      }
    );
  }
  const sb = window.__supabase;

  // =========================
  // Session Store (fonte única)
  // =========================
  window.__session = null;

  async function ensureSessionLoaded() {
    if (window.__session) return window.__session;
    const { data, error } = await sb.auth.getSession();
    if (error) throw error;
    window.__session = data.session || null;
    return window.__session;
  }




  // =========================
  // AUTH UI (Email/Senha + Cadastro no mesmo painel)
  // =========================
  let authMode = "login"; // "login" | "signup"

  const authModeBadge = document.getElementById("authModeBadge");
  const btnToggleAuthMode = document.getElementById("btnToggleAuthMode");
  const btnAuthSubmit = document.getElementById("btnAuthSubmit");
  const btnForgotPass = document.getElementById("btnForgotPass");

  const authEmail = document.getElementById("authEmail");
  const authPassword = document.getElementById("authPassword");
  const authPassword2 = document.getElementById("authPassword2");
  const authName = document.getElementById("authName");
  const authBirth = document.getElementById("authBirth");

  // ✅ Birth UI (Dia/Mês/Ano) - substitui o input date visual, mantém authBirth como hidden
  const birthDay = document.getElementById("birthDay");
  const birthMonth = document.getElementById("birthMonth");
  const birthYear = document.getElementById("birthYear");

  // preenche dia e ano
  (function initBirthSelects() {
    if (!birthDay || !birthYear) return;

    for (let d = 1; d <= 31; d++) {
      const v = String(d).padStart(2, "0");
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      birthDay.appendChild(opt);
    }

    const now = new Date();
    const maxYear = now.getFullYear() - 14;
    const minYear = now.getFullYear() - 100;
    for (let y = maxYear; y >= minYear; y--) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      birthYear.appendChild(opt);
    }
  })();

  function syncBirthHidden() {
    if (!authBirth) return;

    const d = birthDay?.value || "";
    const m = birthMonth?.value || "";
    const y = birthYear?.value || "";

    if (!d || !m || !y) {
      authBirth.value = "";
      return;
    }

    const iso = `${y}-${m}-${d}`;
    const dt = new Date(`${iso}T00:00:00`);
    const isValid = dt && !Number.isNaN(dt.getTime()) &&
      dt.getFullYear() === Number(y) &&
      String(dt.getMonth() + 1).padStart(2, "0") === m &&
      String(dt.getDate()).padStart(2, "0") === d;

    authBirth.value = isValid ? iso : "";
  }

  [birthDay, birthMonth, birthYear].forEach(el => {
    el?.addEventListener("change", syncBirthHidden);
  });

  const authCity = document.getElementById("authCity");
  const signupFields = document.getElementById("signupFields");

  // ✅ elementos do form de recuperação
  const forgotContainer = document.getElementById("forgotContainer");
  const forgotEmail = document.getElementById("forgotEmail");
  const forgotEmail2 = document.getElementById("forgotEmail2");
  const btnSendReset = document.getElementById("btnSendReset");
  const btnCloseForgot = document.getElementById("btnCloseForgot");

  // ✅ alias para corrigir o bug do seu setAuthMode() que usava "btnForgot"
  const btnForgot = btnForgotPass;

  function closeForgotUI() {
    if (forgotContainer) forgotContainer.style.display = "none";
    if (forgotEmail) forgotEmail.value = "";
    if (forgotEmail2) forgotEmail2.value = "";
  }

  function openForgotUI() {
    if (forgotContainer) forgotContainer.style.display = "block";
    const base = (authEmail?.value ?? "").trim();
    if (forgotEmail && !forgotEmail.value) forgotEmail.value = base;
    if (forgotEmail2 && !forgotEmail2.value) forgotEmail2.value = base;
  }

  function setAuthMode(mode) {
    authMode = mode;

    if (authModeBadge) authModeBadge.innerHTML = `Modo: <b>${mode === "login" ? "Login" : "Cadastro"}</b>`;
    if (btnAuthSubmit) btnAuthSubmit.textContent = mode === "login" ? "Entrar" : "Criar conta";
    if (btnToggleAuthMode) btnToggleAuthMode.textContent = mode === "login" ? "Criar conta" : "Já tenho conta";

    if (signupFields) signupFields.style.display = mode === "signup" ? "block" : "none";

    if (btnForgot) btnForgot.style.display = (authMode === "login") ? "inline-block" : "none";

    if (authMode === "signup") closeForgotUI();

    if (authPassword) authPassword.autocomplete = mode === "signup" ? "new-password" : "current-password";

    showLogin("");
  }

  function getTrimmed(el) {
    return (el?.value ?? "").trim().toLowerCase();
  }

  const authEmailErr = document.getElementById("authEmailErr");

  function setEmailError(msg) {
    if (!authEmailErr) return;
    authEmailErr.textContent = msg;
    authEmailErr.style.display = "block";
  }

  function clearEmailError() {
    if (!authEmailErr) return;
    authEmailErr.textContent = "";
    authEmailErr.style.display = "none";
  }

  // limpa erro ao digitar no email
  if (authEmail) {
    authEmail.addEventListener("input", () => clearEmailError());
  }


  function validateAuthInputs() {
    const email = getTrimmed(authEmail);
    const pass = authPassword?.value ?? "";

    if (!email || !email.includes("@")) return "Digite um email válido.";
    if (!pass || pass.length < 8) return "Senha precisa ter pelo menos 8 caracteres.";

    if (authMode === "signup") {
      const pass2 = authPassword2?.value ?? "";
      const name = getTrimmed(authName);
      const birth = authBirth?.value ?? "";
      const city = getTrimmed(authCity);

      if (!pass2) return "Repita a senha.";
      if (pass !== pass2) return "As senhas não conferem.";
      if (!name) return "Digite seu nome.";
      if (!birth) return "Informe sua data de nascimento.";
      if (!city) return "Informe onde você mora (Cidade/Estado).";
    }

    return null;
  }

  function getClient() {
    const client = window.__supabase;
    if (!client || !client.auth) {
      console.error("Supabase client inválido:", client);
      throw new Error("Supabase client não inicializado. Verifique createClient().");
    }
    return client;
  }


  async function doLoginEmail() {
  const email = getTrimmed(authEmail);
  const password = authPassword?.value ?? "";

  const client = getClient();
  const { data, error } = await client.auth.signInWithPassword({ email, password });

  if (error) {
    console.error("Login error:", error);

    const msg = (error.message || "").toLowerCase();

    if (msg.includes("invalid login credentials")) {
      return showLogin("Este email já está vinculado a uma conta Google. Para entrar, clique em “Entrar com conta Google”.");
    }

    return showLogin("Não foi possível entrar. Verifique seu email e senha e tente novamente.");
  }

  if (error) {
    console.error("Login error:", error);

    // mensagens comuns do Supabase
    const msg = (error.message || "").toLowerCase();

    if (msg.includes("email not confirmed")) {
      return showLogin("Seu email ainda não foi confirmado. Abra o email que o Supabase enviou e confirme o cadastro.");
    }

    return showLogin(error.message || "Falha no login. Verifique email/senha e tente novamente.");
  }

  // se logou, segue normal
}


  async function doSignupEmail() {
    clearEmailError();

    const email = getTrimmed(authEmail);
    const password = authPassword?.value ?? "";

    const name = getTrimmed(authName);
    const birth = authBirth?.value ?? "";
    const city = getTrimmed(authCity);

    const client = getClient();

    const { data, error } = await client.auth.signUp({
      email,
      password,
      options: {
        data: { name, birth_date: birth, location: city }
      }
    });

    if (error) {
      console.error("Signup error:", error);

      const msg = (error.message || "").toLowerCase();

      // email já existe (comum)
      if (msg.includes("already") || msg.includes("exists") || msg.includes("registered")) {
        setEmailError("Este email já está cadastrado. Se você já entrou com Google, use “Entrar com conta Google”.");
        return showLogin("");
      }

      showLogin("Não foi possível criar a conta. Verifique os dados e tente novamente.");
      return;
    }

    // ✅ DETECÇÃO: se o Supabase indicar que esse usuário é de Google, bloqueia e orienta
    const provider =
      data?.user?.app_metadata?.provider ||
      data?.user?.identities?.[0]?.provider ||
      "";

    if (String(provider).toLowerCase() === "google") {
      // “desfaz” a ideia de que criou uma conta por senha — e orienta o usuário corretamente
      setEmailError("Este email já está vinculado ao Google. Para acessar, clique em “Entrar com conta Google”.");
      showLogin("");
      setAuthMode("login");
      return;
    }

    // fluxo normal
    showLogin("Conta criada ✅ Agora faça login com seu email e senha.");
    setAuthMode("login");
  }


  async function handleAuthSubmit() {
    const err = validateAuthInputs();
    if (err) return showLogin(err);

    if (btnAuthSubmit) btnAuthSubmit.disabled = true;

    try {
      if (authMode === "login") await doLoginEmail();
      else await doSignupEmail();
    } finally {
      if (btnAuthSubmit) btnAuthSubmit.disabled = false;
    }
  }

  async function handleForgotPassword() {
    if (authMode !== "login") return;
    if (!forgotContainer) return;
    const isOpen = forgotContainer.style.display === "block";
    if (isOpen) closeForgotUI();
    else openForgotUI();
  }

  async function sendResetEmail() {
    const email1 = getTrimmed(forgotEmail) || getTrimmed(authEmail);
    const email2 = getTrimmed(forgotEmail2);

    if (!email1 || !email1.includes("@")) return showLogin("Digite um email válido para recuperação.");
    if (!email2 || email1 !== email2) return showLogin("Os e-mails de recuperação não conferem.");

    const redirectTo = window.location.origin;

    const { error } = await sb.auth.resetPasswordForEmail(email1, { redirectTo });
    if (error) return showLogin("Não consegui enviar o email de recuperação. Tente novamente.");

    showLogin("Enviei um email de recuperação. Verifique sua caixa de entrada/spam.");
    closeForgotUI();
  }

  if (btnToggleAuthMode) {
    btnToggleAuthMode.addEventListener("click", (e) => {
      e.preventDefault();
      setAuthMode(authMode === "login" ? "signup" : "login");
    });
  }

  if (btnForgotPass) {
    btnForgotPass.addEventListener("click", (e) => {
      e.preventDefault();
      handleForgotPassword();
    });
  }


  if (btnAuthSubmit) btnAuthSubmit.addEventListener("click", handleAuthSubmit);
  if (btnForgotPass) btnForgotPass.addEventListener("click", handleForgotPassword);
  if (btnSendReset) btnSendReset.addEventListener("click", sendResetEmail);
  if (btnCloseForgot) btnCloseForgot.addEventListener("click", closeForgotUI);

  // Enter para enviar
  [authEmail, authPassword, authPassword2, authName, authBirth, authCity].forEach(el => {
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleAuthSubmit();
    });
  });

  // Enter nos campos de recuperação envia link
  [forgotEmail, forgotEmail2].forEach(el => {
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendResetEmail();
    });
  });

  // Inicializa modo login
  setAuthMode("login");

  async function loginWithGoogle() {
    const redirectTo = `${window.location.origin}/`; // sempre volta pra URL atual
    const { error } = await sb.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo }
    });
    if (error) showLogin("Falha ao abrir login Google.");
  }


  if (btnLoginGoogle) btnLoginGoogle.addEventListener("click", loginWithGoogle);

  let __loggingOut = false;

  function uiForceToLogin(msg = "Você saiu da conta.") {
    // limpa store
    window.__session = null;

    // fecha modal se estiver aberto
    const ideaModalBack = document.getElementById("ideaModalBack");
    if (ideaModalBack) ideaModalBack.style.display = "none";

    // reseta views
    const viewDashboard = document.getElementById("viewDashboard");
    const viewProfile = document.getElementById("viewProfile");
    if (viewProfile) viewProfile.style.display = "none";
    if (viewDashboard) viewDashboard.style.display = "block";

    // troca telas
    const appRoot = document.getElementById("appRoot");
    const authScreen = document.getElementById("authScreen");
    if (appRoot) appRoot.style.display = "none";
    if (authScreen) authScreen.style.display = "block";

    // mensagem
    if (typeof window.showLogin === "function") window.showLogin(msg);
    else {
      const authMsg = document.getElementById("authMsg");
      if (authMsg) authMsg.textContent = msg;
    }
  }

  function withTimeout(promise, ms, label) {
    let t;
    const timeout = new Promise((_, reject) => {
      t = setTimeout(() => reject(new Error(`Timeout em ${label} (${ms}ms)`)), ms);
    });
    return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
  }

  window.logout = async function logout() {
    if (__loggingOut) return;
    __loggingOut = true;

    console.log("logout: clique (instant)");
    uiForceToLogin("Você saiu da conta.");
    clearCachedProject();


    // tenta signOut, mas não bloqueia a experiência
    try {
      await withTimeout(sb.auth.signOut(), 15000, "signOut");
      console.log("logout: signOut OK");
    } catch (e) {
      console.warn("logout: signOut falhou/timeout (ok):", e?.message || e);
    } finally {
      __loggingOut = false;
    }
  };




  // =========================
  // Dashboard Base: só Perfil / Sair
  // =========================
  const viewDashboard = document.getElementById("viewDashboard");
  const viewProfile = document.getElementById("viewProfile");
  const btnGoProfile = document.getElementById("btnGoProfile");
  const btnBackDashboard = document.getElementById("btnBackDashboard");
  const btnLogoutTop = document.getElementById("btnLogoutTop");

  const dashUserLine = document.getElementById("dashUserLine");
  const profileEmail = document.getElementById("profileEmail");
  const profileProvider = document.getElementById("profileProvider");
  const profileMeta = document.getElementById("profileMeta");

  function showDashboardView() {
    if (viewProfile) viewProfile.style.display = "none";
    if (viewDashboard) viewDashboard.style.display = "block";
  }

  function showProfileView() {
    if (viewDashboard) viewDashboard.style.display = "none";
    if (viewProfile) viewProfile.style.display = "block";
  }

  async function hydrateUserUI(session) {
    try {
      const user = session?.user;
      const email = user?.email || "—";
      const provider = (user?.app_metadata?.provider) ? String(user.app_metadata.provider) : "—";

      if (dashUserLine) dashUserLine.textContent = `Logado como: ${email}`;
      if (profileEmail) profileEmail.textContent = `Email: ${email}`;
      if (profileProvider) profileProvider.textContent = `Provider: ${provider}`;
      if (profileMeta) profileMeta.textContent = JSON.stringify({
        id: user?.id,
        app_metadata: user?.app_metadata,
        user_metadata: user?.user_metadata,
        created_at: user?.created_at
      }, null, 2);
    } catch (e) {
      console.error("hydrateUserUI erro:", e);
    }
  }

  if (btnGoProfile) btnGoProfile.addEventListener("click", async () => {
    const session = window.__session || await ensureSessionLoaded();
    if (!session) throw new Error("Sessão não encontrada. Faça login novamente.");

    await createSeedProject(session);
    await hydrateUserUI(session);
    showProfileView();
  });

  if (btnBackDashboard) btnBackDashboard.addEventListener("click", () => {
    showDashboardView();
  });

  if (btnLogoutTop) btnLogoutTop.onclick = () => window.logout();

  function isAuthCallbackUrl() {
    const h = window.location.hash || "";
    // Só considera callback se vier token no HASH (OAuth implicit flow)
    return h.includes("access_token=") || h.includes("refresh_token=");
  }

  window.bootAuthGate = async function bootAuthGate() {
    try {
      const { data, error } = await withTimeout(sb.auth.getSession(), 15000, "boot.getSession");
      if (error) throw error;

      const session = data.session || null;
      window.__session = session;

      if (!session) return showLogin();

      showApp();
      showDashboardView();
      await hydrateUserUI(session);
      await renderSeedToFruitState(session);
    } catch (e) {
      console.error("[boot] erro:", e);
      showLogin();
    }
  };



  let __lastAuthRenderAt = 0;

  sb.auth.onAuthStateChange(async (event, session) => {
    console.log("[Auth] event:", event, "session:", !!session);
    window.__session = session || null;

    if (!session) return showLogin();

    // atualiza UI leve sempre
    showApp();
    showDashboardView();
    await hydrateUserUI(session);

    // Se token foi refreshed, NÃO busque projeto agora (janela ruim)
    if (event === "TOKEN_REFRESHED") {
      pauseProjectFetch(5000, "TOKEN_REFRESHED"); // 5s
      return; // <<< evita render duplicado + abort
    }

    // Para SIGNED_IN / INITIAL_SESSION, renderiza normal
    if (event === "SIGNED_IN" || event === "INITIAL_SESSION") {
      await renderSeedToFruitState(session);
    }
  });





  window.bootAuthGate();

  // =========================
  // SeedToFruit: UI + Render
  // =========================
  const seedEmptyState = document.getElementById("seedEmptyState");
  const btnAddFirstIdea = document.getElementById("btnAddFirstIdea");

  const ideaModalBack = document.getElementById("ideaModalBack");
  const btnCloseIdeaModal = document.getElementById("btnCloseIdeaModal");
  const btnCreateIdea = document.getElementById("btnCreateIdea");
  const ideaModalMsg = document.getElementById("ideaModalMsg");

  const ideaTitle = document.getElementById("ideaTitle");
  const ideaRaw = document.getElementById("ideaRaw");
  const ideaUser = document.getElementById("ideaUser");
  const ideaPain = document.getElementById("ideaPain");

  function openIdeaModal() {
    if (ideaModalMsg) ideaModalMsg.textContent = "";
    if (ideaModalBack) ideaModalBack.style.display = "flex";
  }
  function closeIdeaModal() {
    if (ideaModalBack) ideaModalBack.style.display = "none";
  }

  btnAddFirstIdea?.addEventListener("click", openIdeaModal);
  btnCloseIdeaModal?.addEventListener("click", closeIdeaModal);
  ideaModalBack?.addEventListener("click", (e) => {
    if (e.target === ideaModalBack) closeIdeaModal();
  });

  function todayISODate() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function isAbortError(err) {
    const msg = (err?.message || "").toLowerCase();
    return msg.includes("aborterror") || msg.includes("signal is aborted");
  }

  let __lastActiveProject = null;

  function isTransientError(err) {
    const msg = (err?.message || "").toLowerCase();
    return (
      msg.includes("aborterror") ||
      msg.includes("signal is aborted") ||
      msg.includes("timeout em projects.select(active)")
    );
  }



  async function getActiveProject(userId) {
    async function run(timeoutMs) {
      const req = sb
        .from("projects")
        .select("*")
        .eq("user_id", userId)
        .eq("status", "active")
        .order("created_at", { ascending: false })
        .limit(1);

      const { data, error } = await withTimeout(req, timeoutMs, "projects.select(active)");
      if (error) throw error;

      return data?.[0] || null;
    }

    try {
      // no retorno de aba, pode demorar: 15s
      const p = await run(15000);
      __lastActiveProject = p || __lastActiveProject;
      return p;
    } catch (e) {
      if (isTransientError(e)) {
        console.warn("[SeedToFruit] erro transitório ao buscar projeto. Retry 1x...");
        await new Promise(r => setTimeout(r, 500));

        try {
          const p2 = await run(15000);
          __lastActiveProject = p2 || __lastActiveProject;
          return p2;
        } catch (e2) {
          console.warn("[SeedToFruit] retry falhou, mantendo último projeto conhecido.");
          return __lastActiveProject; // <<< NÃO some a UI
        }
      }
      throw e; // erro real (RLS, permissão etc.)
    }
  }

  let __lastProjectRefreshAt = 0;

  const ACTIVE_PROJECT_CACHE_KEY = "seedtofruit_active_project_cache";
  let __activeProjectCache = null;

  function loadCachedProject() {
    try {
      const raw = localStorage.getItem(ACTIVE_PROJECT_CACHE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function saveCachedProject(p) {
    try {
      if (!p) return;
      localStorage.setItem(ACTIVE_PROJECT_CACHE_KEY, JSON.stringify(p));
    } catch {}
  }

  function clearCachedProject() {
  try {
    localStorage.removeItem(ACTIVE_PROJECT_CACHE_KEY);
  } catch {}
  __activeProjectCache = null;
}

  // carrega ao iniciar
  __activeProjectCache = loadCachedProject();


  async function renderSeedToFruitState(session, opts = {}) {
    const allowFetch = opts.allowFetch !== false; // default true
    console.log("[SeedToFruit] renderSeedToFruitState()");
    const userId = session?.user?.id;
    console.log("[SeedToFruit] userId =", userId);
    if (!userId) return;

    // pinta rápido com cache (zero travamento)
    if (__activeProjectCache?.id) {
      if (seedEmptyState) seedEmptyState.style.display = "none";
      if (dashUserLine) dashUserLine.textContent =
        `Logado como: ${session.user.email} • Projeto: ${__activeProjectCache.title}`;
    }


    let active = null;
    try {
      active = await getActiveProject(userId);
    } catch (e) {
      console.error("[SeedToFruit] erro ao buscar projeto (não transitório):", e);
      // aqui sim você pode decidir mostrar login ou uma mensagem
      return;
    }
    
    console.log("[SeedToFruit] activeProject =", active);

    if (!active) {
      // se não tem mesmo (e não é erro), mostra empty
      if (seedEmptyState) seedEmptyState.style.display = "block";
      if (dashUserLine) dashUserLine.textContent = `Logado como: ${session.user.email}`;
      return;
    }

    if (seedEmptyState) seedEmptyState.style.display = "none";
    if (dashUserLine) dashUserLine.textContent = `Logado como: ${session.user.email} • Projeto: ${active.title}`;
  }

  if (!allowFetch) {
    console.log("[SeedToFruit] render (sem fetch) por opts");
    return;
  }

  if (isProjectFetchPaused()) {
    console.log("[SeedToFruit] fetch pausado, mantendo cache");
    return;
  }



  async function createSeedProject(session) {
    const userId = session?.user?.id;
    if (!userId) return;

    const title = (ideaTitle?.value || "").trim();
    const raw = (ideaRaw?.value || "").trim();
    const usr = (ideaUser?.value || "").trim();
    const pain = (ideaPain?.value || "").trim();

    if (!title || title.length < 3) throw new Error("Dê um título curto para sua ideia.");
    if (!raw || raw.length < 10) throw new Error("Explique a ideia com um pouco mais de detalhes.");
    if (!usr) throw new Error("Informe quem vai usar.");
    if (!pain) throw new Error("Informe a dor principal.");

    const { data: proj, error: e1 } = await sb
      .from("projects")
      .insert({
        user_id: userId,
        title,
        idea_raw: raw,
        status: "active",
        current_phase: 1
      })
      .select("*")
      .single();
    if (e1) throw new Error(`projects.insert: ${e1.message}`);

    const phase1Questions = [
      "Quem vai usar isso?",
      "O que essa pessoa tenta fazer hoje e não consegue bem?",
      "O que ela reclama com frequência?",
      "O que ela perde por causa disso? (tempo, dinheiro, esforço, estresse)",
      "Se esse problema desaparecesse, o que mudaria na vida dela?"
    ];

    const { error: e2 } = await sb
      .from("project_phases")
      .insert({
        project_id: proj.id,
        phase_number: 1,
        phase_title: "Clareza da Dor",
        status: "active",
        content_json: { who: usr, pain, questions: phase1Questions, answers: {} }
      });
    if (e2) throw new Error(`project_phases.insert: ${e2.message}`);

    const day = todayISODate();
    const routine = {
      sleep_hours: 7,
      lunch_minutes: 60,
      wake_time: "06:30",
      sleep_time: "23:30",
      notes: "Rotina inicial (será recalibrada pela IA depois)."
    };

    const { data: daily, error: e3 } = await sb
      .from("daily_plans")
      .insert({
        project_id: proj.id,
        day_date: day,
        focus_title: "Definir a dor com clareza",
        routine_json: routine,
        progress_percent: 0
      })
      .select("*")
      .single();
    if (e3) throw new Error(`daily_plans.insert: ${e3.message}`);

    const tasks = [
      { daily_plan_id: daily.id, title: "Escrever a Frase da Dor", description: "Pessoas que _____ sofrem com _____ porque _____.", priority: 1, type: "focus", xp_reward: 20 },
      { daily_plan_id: daily.id, title: "Responder as perguntas da Fase 1", description: "Preencha as respostas do Prompt Mestre (fase 1).", priority: 1, type: "task", xp_reward: 30 },
      { daily_plan_id: daily.id, title: "Listar 3 pessoas reais para falar", description: "Quem você pode entrevistar ainda essa semana?", priority: 2, type: "validation", xp_reward: 20 }
    ];

    const { error: e4 } = await sb.from("tasks").insert(tasks);
    if (e4) throw new Error(`tasks.insert: ${e4.message}`);

    __activeProjectCache = proj;
    saveCachedProject(proj);

    return proj;
  }

  function withTimeout(promise, ms, label) {
  let t;
  const timeout = new Promise((_, reject) => {
    t = setTimeout(() => reject(new Error(`Timeout em ${label} (${ms}ms)`)), ms);
  });
  return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
}

  btnCreateIdea?.addEventListener("click", async () => {
    try {
      btnCreateIdea.disabled = true;
      if (ideaModalMsg) ideaModalMsg.textContent = "1/4 Validando sessão…";

      const { data: { session }, error: sErr } = await withTimeout(sb.auth.getSession(), 8000, "getSession");
      if (sErr) throw sErr;
      if (!session) throw new Error("Sessão não encontrada. Faça login novamente.");

      if (ideaModalMsg) ideaModalMsg.textContent = "2/4 Criando projeto…";
      const proj = await withTimeout(createSeedProject(session), 15000, "createSeedProject");

      if (ideaModalMsg) ideaModalMsg.textContent = "3/4 Atualizando tela…";
      closeIdeaModal();

      await withTimeout(renderSeedToFruitState(session), 8000, "renderSeedToFruitState");

      if (ideaModalMsg) ideaModalMsg.textContent = "4/4 Pronto ✅";
      console.log("[SeedToFruit] Projeto criado:", proj);
    } catch (e) {
      console.error("[SeedToFruit] erro ao criar projeto:", e);
      if (ideaModalMsg) ideaModalMsg.textContent = e?.message || "Falha ao criar projeto.";
    } finally {
      btnCreateIdea.disabled = false;
    }
  });

  const active = await getActiveProject(userId);
    if (active) {
      __activeProjectCache = active;
      saveCachedProject(active);
    }


  let __rehydrating = false;
  let __rehydrateCooldownUntil = 0;
  let __rehydrateTimer = null;

  async function tryGetSessionSafe() {
    // tenta com timeout maior e 1 retry
    try {
      return await withTimeout(sb.auth.getSession(), 15000, "rehydrate.getSession");
    } catch (e) {
      const msg = (e?.message || "").toLowerCase();
      if (msg.includes("timeout")) {
        console.warn("[rehydrate] getSession timeout, retry 1x...");
        await new Promise(r => setTimeout(r, 700));
        return await withTimeout(sb.auth.getSession(), 15000, "rehydrate.getSession.retry");
      }
      throw e;
    }
  }

  async function rehydrateApp(reason) {
    const now = Date.now();
    if (__rehydrating) return;

    if (now < __rehydrateCooldownUntil) {
      console.log(`[rehydrate] skip (cooldown) reason=${reason}`);
      return;
    }

    __rehydrating = true;
    __rehydrateCooldownUntil = now + 3000;

    try {
      console.log(`[rehydrate] start (${reason})`);

      // 1) Caminho rápido: se já temos sessão em memória, só re-renderiza.
      const memSession = window.__session;
      if (memSession?.user?.id) {
        showApp();
        showDashboardView();
        await hydrateUserUI(memSession);
          const needsRefresh =
              !__activeProjectCache || (Date.now() - __lastProjectRefreshAt > 10000);

            if (needsRefresh) {
              // pinta com cache e adia fetch real se estiver em janela ruim
              await renderSeedToFruitState(memSession, { allowFetch: false });

              setTimeout(() => {
                const s = window.__session;
                if (s?.user?.id) renderSeedToFruitState(s, { allowFetch: true });
              }, 2500);
              __lastProjectRefreshAt = Date.now();
            } else {
              console.log("[rehydrate] skip project refresh (cache recente)");
            }

        console.log("[rehydrate] done (memory session)");
        return;
      }

      // 2) Fallback: só se não tiver sessão em memória, tenta getSession com segurança
      const { data, error } = await tryGetSessionSafe();
      if (error) throw error;

      const session = data.session || null;
      window.__session = session;

      if (!session) {
        showLogin();
        console.log("[rehydrate] done (no session)");
        return;
      }

      showApp();
      showDashboardView();
      await hydrateUserUI(session);
      await renderSeedToFruitState(session);

      console.log("[rehydrate] done");
    } catch (e) {
      // Importante: NÃO derrubar UI por timeout do getSession.
      console.error("[rehydrate] erro (ignorado para não travar UI):", e);

      // Se não conseguiu rehydrate, mas existe sessão em memória, mantém a tela.
      if (window.__session?.user?.id) {
        console.log("[rehydrate] mantendo sessão em memória");
        return;
      }

      // Se não tem sessão em memória e falhou, volta pro login com mensagem leve
      showLogin("Reconectando… tente novamente.");
    } finally {
      __rehydrating = false;
    }
  }

  function scheduleRehydrate(reason) {
    clearTimeout(__rehydrateTimer);
    __rehydrateTimer = setTimeout(() => rehydrateApp(reason), 250);
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") scheduleRehydrate("visibilitychange");
  });

  window.addEventListener("pageshow", (e) => {
    if (e.persisted) scheduleRehydrate("pageshow-bfcache");
  });


</script>

</body>
</html>
